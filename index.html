<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Sport Itapuí - Agendamento de Tênis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        .slot-booked { background-color: #ef4444; color: white; }
        .slot-available { background-color: #10b981; color: white; }
        .slot-my-booking { background-color: #3b82f6; color: white; }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-3 sm:p-4">
        <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-8 w-full max-w-sm sm:max-w-md">
            <div class="text-center mb-6 sm:mb-8">
                <img src="https://i.postimg.cc/9FG4YkXP/logo.jpg" alt="Sport Itapuí" class="w-16 h-16 sm:w-24 sm:h-24 mx-auto mb-3 sm:mb-4 rounded-full shadow-lg" onerror="this.style.display='none'; document.getElementById('fallbackTitle').style.display='block';">
                <h1 id="fallbackTitle" class="text-xl sm:text-3xl font-bold text-green-800 mb-2" style="display: none;">🎾 Sport Itapuí</h1>
                <h1 class="text-xl sm:text-3xl font-bold text-green-800 mb-2">Sport Itapuí</h1>
                <p class="text-sm sm:text-base text-gray-600">Sistema de Agendamento de Tênis</p>
            </div>
            
            <div class="space-y-3 sm:space-y-4">
                <button onclick="showMemberLogin()" class="w-full bg-green-600 hover:bg-green-700 active:bg-green-800 text-white font-semibold py-4 px-6 rounded-lg transition duration-200 text-base sm:text-lg">
                    Acesso do Sócio
                </button>
                <button onclick="showAdminLogin()" class="w-full bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-semibold py-4 px-6 rounded-lg transition duration-200 text-base sm:text-lg">
                    Painel Administrativo
                </button>
            </div>
        </div>
    </div>

    <!-- Member Login -->
    <div id="memberLogin" class="hidden min-h-screen flex items-center justify-center p-3 sm:p-4">
        <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-8 w-full max-w-sm sm:max-w-md">
            <div class="text-center mb-6 sm:mb-8">
                <img src="https://i.postimg.cc/9FG4YkXP/logo.jpg" alt="Sport Itapuí" class="w-16 h-16 sm:w-20 sm:h-20 mx-auto mb-3 sm:mb-4 rounded-full shadow-lg" onerror="this.style.display='none';">
                <h2 class="text-lg sm:text-2xl font-bold text-green-800 mb-2">Acesso do Sócio</h2>
                <p class="text-sm sm:text-base text-gray-600">Digite seus dados para acessar</p>
            </div>
            
            <form onsubmit="memberLogin(event)" class="space-y-4 sm:space-y-5">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome Completo</label>
                    <input type="text" id="memberName" required class="w-full px-4 py-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">CPF</label>
                    <input type="text" id="memberCPF" required placeholder="000.000.000-00" maxlength="14" class="w-full px-4 py-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" oninput="formatCPF(this)" onblur="validateCPF(this)">
                    <div id="cpfError" class="text-red-500 text-sm mt-1 hidden">CPF inválido</div>
                </div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 active:bg-green-800 text-white font-semibold py-4 px-6 rounded-lg transition duration-200 text-base sm:text-lg">
                    Entrar
                </button>
                <button type="button" onclick="showLoginScreen()" class="w-full bg-gray-500 hover:bg-gray-600 active:bg-gray-700 text-white font-semibold py-4 px-6 rounded-lg transition duration-200 text-base sm:text-lg">
                    Voltar
                </button>
            </form>
        </div>
    </div>

    <!-- Admin Login -->
    <div id="adminLogin" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <img src="https://i.postimg.cc/9FG4YkXP/logo.jpg" alt="Sport Itapuí" class="w-20 h-20 mx-auto mb-4 rounded-full shadow-lg" onerror="this.style.display='none';">
                <h2 class="text-2xl font-bold text-blue-800 mb-2">Painel Administrativo</h2>
                <p class="text-gray-600">Acesso restrito</p>
            </div>
            
            <form onsubmit="adminLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Usuário</label>
                    <input type="text" id="adminUser" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                    <input type="password" id="adminPass" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                    Entrar
                </button>
                <button type="button" onclick="showLoginScreen()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                    Voltar
                </button>
            </form>
        </div>
    </div>

    <!-- Member Dashboard -->
    <div id="memberDashboard" class="hidden min-h-screen p-2 sm:p-4">
        <div class="max-w-7xl mx-auto">
            <div class="bg-white rounded-xl shadow-lg p-3 sm:p-6 mb-4 sm:mb-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-4 sm:space-y-0">
                    <div class="flex items-center space-x-3 sm:space-x-4">
                        <img src="https://i.postimg.cc/9FG4YkXP/logo.jpg" alt="Sport Itapuí" class="w-12 h-12 sm:w-16 sm:h-16 rounded-full shadow-lg" onerror="this.style.display='none';">
                        <div>
                            <h1 class="text-lg sm:text-2xl font-bold text-green-800">🎾 Agendamento de Tênis</h1>
                            <p class="text-sm sm:text-base text-gray-600">Bem-vindo, <span id="currentMemberName"></span></p>
                        </div>
                    </div>
                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 sm:px-4 sm:py-2 rounded-lg transition duration-200 text-sm sm:text-base">
                        Sair
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-3 sm:p-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 sm:mb-6 space-y-4 sm:space-y-0">
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-800">Semana de <span id="currentWeekDisplay"></span></h2>
                    <div class="flex flex-wrap gap-2 sm:gap-4">
                        <div class="flex items-center space-x-1 sm:space-x-2">
                            <div class="w-3 h-3 sm:w-4 sm:h-4 bg-green-500 rounded"></div>
                            <span class="text-xs sm:text-sm">Disponível</span>
                        </div>
                        <div class="flex items-center space-x-1 sm:space-x-2">
                            <div class="w-3 h-3 sm:w-4 sm:h-4 bg-red-500 rounded"></div>
                            <span class="text-xs sm:text-sm">Ocupado</span>
                        </div>
                        <div class="flex items-center space-x-1 sm:space-x-2">
                            <div class="w-3 h-3 sm:w-4 sm:h-4 bg-blue-500 rounded"></div>
                            <span class="text-xs sm:text-sm">Meus agendamentos</span>
                        </div>
                    </div>
                </div>

                <!-- Day Tabs -->
                <div class="flex flex-wrap gap-1 mb-6 border-b border-gray-200 overflow-x-auto">
                    <button onclick="selectDay(0)" id="dayTab0" class="day-tab flex-shrink-0 px-4 py-3 text-sm font-medium rounded-t-lg transition-colors duration-200 bg-green-600 text-white border-b-2 border-green-600 min-w-[80px] touch-manipulation">
                        Segunda
                    </button>
                    <button onclick="selectDay(1)" id="dayTab1" class="day-tab flex-shrink-0 px-4 py-3 text-sm font-medium rounded-t-lg transition-colors duration-200 bg-gray-100 text-gray-600 hover:bg-gray-200 active:bg-gray-300 min-w-[80px] touch-manipulation">
                        Terça
                    </button>
                    <button onclick="selectDay(2)" id="dayTab2" class="day-tab flex-shrink-0 px-4 py-3 text-sm font-medium rounded-t-lg transition-colors duration-200 bg-gray-100 text-gray-600 hover:bg-gray-200 active:bg-gray-300 min-w-[80px] touch-manipulation">
                        Quarta
                    </button>
                    <button onclick="selectDay(3)" id="dayTab3" class="day-tab flex-shrink-0 px-4 py-3 text-sm font-medium rounded-t-lg transition-colors duration-200 bg-gray-100 text-gray-600 hover:bg-gray-200 active:bg-gray-300 min-w-[80px] touch-manipulation">
                        Quinta
                    </button>
                    <button onclick="selectDay(4)" id="dayTab4" class="day-tab flex-shrink-0 px-4 py-3 text-sm font-medium rounded-t-lg transition-colors duration-200 bg-gray-100 text-gray-600 hover:bg-gray-200 active:bg-gray-300 min-w-[80px] touch-manipulation">
                        Sexta
                    </button>
                    <button onclick="selectDay(5)" id="dayTab5" class="day-tab flex-shrink-0 px-4 py-3 text-sm font-medium rounded-t-lg transition-colors duration-200 bg-gray-100 text-gray-600 hover:bg-gray-200 active:bg-gray-300 min-w-[80px] touch-manipulation">
                        Sábado
                    </button>
                    <button onclick="selectDay(6)" id="dayTab6" class="day-tab flex-shrink-0 px-4 py-3 text-sm font-medium rounded-t-lg transition-colors duration-200 bg-gray-100 text-gray-600 hover:bg-gray-200 active:bg-gray-300 min-w-[80px] touch-manipulation">
                        Domingo
                    </button>
                </div>

                <!-- Day Content -->
                <div id="dayContent" class="min-h-[400px]">
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 sm:gap-3 md:gap-4" id="timeSlots">
                        <!-- Time slots will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden min-h-screen p-2 sm:p-4">
        <div class="max-w-7xl mx-auto">
            <div class="bg-white rounded-xl shadow-lg p-3 sm:p-6 mb-4 sm:mb-6">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center space-y-4 lg:space-y-0">
                    <div class="flex items-center space-x-3 sm:space-x-4">
                        <img src="https://i.postimg.cc/9FG4YkXP/logo.jpg" alt="Sport Itapuí" class="w-12 h-12 sm:w-16 sm:h-16 rounded-full shadow-lg" onerror="this.style.display='none';">
                        <div>
                            <h1 class="text-lg sm:text-2xl font-bold text-blue-800">🎾 Painel Administrativo</h1>
                            <p class="text-sm sm:text-base text-gray-600">Gestão de agendamentos</p>
                        </div>
                    </div>
                    <div class="flex flex-col space-y-2 w-full lg:w-auto">
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                            <button onclick="previousWeek()" class="bg-gray-600 hover:bg-gray-700 active:bg-gray-800 text-white px-4 py-3 rounded-lg transition duration-200 text-sm font-medium touch-manipulation">
                                ← Semana Anterior
                            </button>
                            <button onclick="nextWeek()" class="bg-gray-600 hover:bg-gray-700 active:bg-gray-800 text-white px-4 py-3 rounded-lg transition duration-200 text-sm font-medium touch-manipulation">
                                Próxima Semana →
                            </button>
                        </div>
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                            <button onclick="setActiveWeek()" class="bg-purple-600 hover:bg-purple-700 active:bg-purple-800 text-white px-4 py-3 rounded-lg transition duration-200 text-sm font-medium touch-manipulation">
                                Definir como Vigente
                            </button>
                            <button onclick="toggleBlockMode()" id="blockModeBtn" class="bg-orange-600 hover:bg-orange-700 active:bg-orange-800 text-white px-4 py-3 rounded-lg transition duration-200 text-sm font-medium touch-manipulation">
                                Modo Bloqueio: OFF
                            </button>
                            <button onclick="openBlockModal()" class="bg-yellow-600 hover:bg-yellow-700 active:bg-yellow-800 text-white px-4 py-3 rounded-lg transition duration-200 text-sm font-medium touch-manipulation">
                                Gerenciar Bloqueios
                            </button>
                            <button onclick="logout()" class="bg-red-500 hover:bg-red-600 active:bg-red-700 text-white px-4 py-3 rounded-lg transition duration-200 text-sm font-medium touch-manipulation">
                                Sair
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-3 sm:p-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 sm:mb-6">
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-800">Todos os Agendamentos - Semana de <span id="adminCurrentWeekDisplay"></span></h2>
                    <div id="activeWeekIndicator" class="mt-2 sm:mt-0 px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-medium hidden">
                        ✓ Semana Vigente
                    </div>
                </div>

                <!-- Admin Day Tabs -->
                <div class="flex flex-wrap gap-1 mb-6 border-b border-gray-200 overflow-x-auto">
                    <button onclick="selectAdminDay(0)" id="adminDayTab0" class="admin-day-tab flex-shrink-0 px-4 py-3 text-sm font-medium rounded-t-lg transition-colors duration-200 bg-blue-600 text-white border-b-2 border-blue-600 min-w-[80px] touch-manipulation">
                        Segunda
                    </button>
                    <button onclick="selectAdminDay(1)" id="adminDayTab1" class="admin-day-tab flex-shrink-0 px-4 py-3 text-sm font-medium rounded-t-lg transition-colors duration-200 bg-gray-100 text-gray-600 hover:bg-gray-200 active:bg-gray-300 min-w-[80px] touch-manipulation">
                        Terça
                    </button>
                    <button onclick="selectAdminDay(2)" id="adminDayTab2" class="admin-day-tab flex-shrink-0 px-4 py-3 text-sm font-medium rounded-t-lg transition-colors duration-200 bg-gray-100 text-gray-600 hover:bg-gray-200 active:bg-gray-300 min-w-[80px] touch-manipulation">
                        Quarta
                    </button>
                    <button onclick="selectAdminDay(3)" id="adminDayTab3" class="admin-day-tab flex-shrink-0 px-4 py-3 text-sm font-medium rounded-t-lg transition-colors duration-200 bg-gray-100 text-gray-600 hover:bg-gray-200 active:bg-gray-300 min-w-[80px] touch-manipulation">
                        Quinta
                    </button>
                    <button onclick="selectAdminDay(4)" id="adminDayTab4" class="admin-day-tab flex-shrink-0 px-4 py-3 text-sm font-medium rounded-t-lg transition-colors duration-200 bg-gray-100 text-gray-600 hover:bg-gray-200 active:bg-gray-300 min-w-[80px] touch-manipulation">
                        Sexta
                    </button>
                    <button onclick="selectAdminDay(5)" id="adminDayTab5" class="admin-day-tab flex-shrink-0 px-4 py-3 text-sm font-medium rounded-t-lg transition-colors duration-200 bg-gray-100 text-gray-600 hover:bg-gray-200 active:bg-gray-300 min-w-[80px] touch-manipulation">
                        Sábado
                    </button>
                    <button onclick="selectAdminDay(6)" id="adminDayTab6" class="admin-day-tab flex-shrink-0 px-4 py-3 text-sm font-medium rounded-t-lg transition-colors duration-200 bg-gray-100 text-gray-600 hover:bg-gray-200 active:bg-gray-300 min-w-[80px] touch-manipulation">
                        Domingo
                    </button>
                </div>

                <!-- Admin Day Content -->
                <div id="adminDayContent" class="min-h-[400px]">
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 sm:gap-4" id="adminTimeSlots">
                        <!-- Time slots will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Booking Modal -->
    <div id="bookingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-3 z-50">
        <div class="bg-white rounded-xl shadow-2xl p-5 w-full max-w-sm mx-3">
            <h3 class="text-lg font-bold text-gray-800 mb-4 text-center">Confirmar Agendamento</h3>
            <p class="text-base text-gray-600 mb-6 text-center">Deseja agendar o horário de <span id="bookingTime" class="font-semibold text-green-600"></span> na <span id="bookingDay" class="font-semibold text-green-600"></span>?</p>
            <div class="flex flex-col space-y-3">
                <button onclick="confirmBooking()" class="w-full bg-green-600 hover:bg-green-700 active:bg-green-800 text-white font-semibold py-4 px-6 rounded-lg transition duration-200 text-base touch-manipulation">
                    Confirmar Agendamento
                </button>
                <button onclick="closeBookingModal()" class="w-full bg-gray-500 hover:bg-gray-600 active:bg-gray-700 text-white font-semibold py-4 px-6 rounded-lg transition duration-200 text-base touch-manipulation">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Cancel Modal -->
    <div id="cancelModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-3 z-50">
        <div class="bg-white rounded-xl shadow-2xl p-5 w-full max-w-sm mx-3">
            <h3 class="text-lg font-bold text-gray-800 mb-4 text-center">Cancelar Agendamento</h3>
            <p class="text-base text-gray-600 mb-6 text-center">Deseja cancelar o agendamento de <span id="cancelTime" class="font-semibold text-red-600"></span> na <span id="cancelDay" class="font-semibold text-red-600"></span>?</p>
            <div class="flex flex-col space-y-3">
                <button onclick="confirmCancel()" class="w-full bg-red-600 hover:bg-red-700 active:bg-red-800 text-white font-semibold py-4 px-6 rounded-lg transition duration-200 text-base touch-manipulation">
                    Cancelar Agendamento
                </button>
                <button onclick="closeCancelModal()" class="w-full bg-gray-500 hover:bg-gray-600 active:bg-gray-700 text-white font-semibold py-4 px-6 rounded-lg transition duration-200 text-base touch-manipulation">
                    Voltar
                </button>
            </div>
        </div>
    </div>

    <!-- Block Management Modal -->
    <div id="blockModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-3 z-50">
        <div class="bg-white rounded-xl shadow-2xl p-5 w-full max-w-md mx-3 max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold text-gray-800 mb-4 text-center">Gerenciar Bloqueios Fixos</h3>
            
            <div class="mb-6">
                <h4 class="text-md font-semibold text-gray-700 mb-3">Bloqueios Ativos:</h4>
                <div id="activeBlocksList" class="space-y-2 max-h-48 overflow-y-auto">
                    <!-- Active blocks will be populated here -->
                </div>
            </div>

            <div class="flex flex-col space-y-3">
                <button onclick="closeBlockModal()" class="w-full bg-gray-500 hover:bg-gray-600 active:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 text-base touch-manipulation">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <script>
        // -------------------------
        // Supabase config - SUBSTITUA AQUI
        // -------------------------
        const supabaseUrl = "https://SEU-PROJETO.supabase.co"; // <-- substitua
        const supabaseKey = "SEU-ANON-KEY"; // <-- substitua
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // Global variables
        let currentUser = null;
        let isAdmin = false;
        let currentWeekStart = null;
        let activeWeekStart = null; // Week that is currently active for bookings
        let bookings = {};
        let blockedSlots = {}; // Fixed blocked slots that apply to future weeks
        let isBlockMode = false; // Whether admin is in block mode
        let selectedSlot = null;
        let selectedDay = 0; // Currently selected day for member view
        let selectedAdminDay = 0; // Currently selected day for admin view

        // Initialize system
        async function initSystem() {
            // Set current week to this Monday
            const today = new Date();
            const dayOfWeek = today.getDay();
            const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            currentWeekStart = new Date(today);
            currentWeekStart.setDate(today.getDate() + daysToMonday);
            currentWeekStart.setHours(0, 0, 0, 0);

            // restore week state from localStorage (keeps admin navigation between reloads)
            const savedWeek = localStorage.getItem('currentWeekStart');
            if (savedWeek) {
                const parsed = new Date(savedWeek);
                if (!isNaN(parsed)) currentWeekStart = parsed;
            }

            const savedActiveWeek = localStorage.getItem('activeWeekStart');
            if (savedActiveWeek) {
                const parsedA = new Date(savedActiveWeek);
                if (!isNaN(parsedA)) activeWeekStart = parsedA;
            } else {
                activeWeekStart = new Date(currentWeekStart);
            }

            // By default members view the active week
            // bookings and blocks are loaded for currentWeekStart
            await loadBlocks();
            await loadBookings();
            updateScheduleDisplay();
            updateAdminScheduleDisplay();
        }

        // Save week state to localStorage (keeps week selection between reloads)
        function saveWeekState() {
            if (currentWeekStart) localStorage.setItem('currentWeekStart', currentWeekStart.toISOString());
            if (activeWeekStart) localStorage.setItem('activeWeekStart', activeWeekStart.toISOString());
        }

        // Screen navigation
        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('memberLogin').classList.add('hidden');
            document.getElementById('adminLogin').classList.add('hidden');
            document.getElementById('memberDashboard').classList.add('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
        }

        function showMemberLogin() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('memberLogin').classList.remove('hidden');
        }

        function showAdminLogin() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('adminLogin').classList.remove('hidden');
        }

        // CPF validation functions
        function formatCPF(input) {
            let value = input.value.replace(/\D/g, '');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            input.value = value;
        }

        function validateCPF(input) {
            const cpf = input.value.replace(/\D/g, '');
            const errorDiv = document.getElementById('cpfError');
            
            if (cpf.length !== 11 || !isValidCPF(cpf)) {
                input.classList.add('border-red-500');
                input.classList.remove('border-gray-300');
                errorDiv.classList.remove('hidden');
                return false;
            } else {
                input.classList.remove('border-red-500');
                input.classList.add('border-gray-300');
                errorDiv.classList.add('hidden');
                return true;
            }
        }

        function isValidCPF(cpf) {
            // Check for known invalid patterns
            if (/^(\d)\1{10}$/.test(cpf)) return false;
            
            // Validate first digit
            let sum = 0;
            for (let i = 0; i < 9; i++) {
                sum += parseInt(cpf.charAt(i)) * (10 - i);
            }
            let remainder = (sum * 10) % 11;
            if (remainder === 10 || remainder === 11) remainder = 0;
            if (remainder !== parseInt(cpf.charAt(9))) return false;
            
            // Validate second digit
            sum = 0;
            for (let i = 0; i < 10; i++) {
                sum += parseInt(cpf.charAt(i)) * (11 - i);
            }
            remainder = (sum * 10) % 11;
            if (remainder === 10 || remainder === 11) remainder = 0;
            if (remainder !== parseInt(cpf.charAt(10))) return false;
            
            return true;
        }

        // Login functions
        async function memberLogin(event) {
            event.preventDefault();
            const name = document.getElementById('memberName').value.trim();
            const cpfInput = document.getElementById('memberCPF');
            const cpf = cpfInput.value.trim();

            if (!validateCPF(cpfInput)) {
                alert('Por favor, digite um CPF válido!');
                return;
            }

            if (name && cpf) {
                // busca sócio por CPF
                let { data: member, error } = await supabase
                    .from('members')
                    .select('*')
                    .eq('cpf', cpf)
                    .maybeSingle();

                if (error) {
                    console.error('Erro ao buscar sócio:', error);
                    alert('Erro ao verificar sócio: ' + error.message);
                    return;
                }

                if (!member) {
                    // cadastra novo sócio
                    const { data: inserted, error: insertError } = await supabase
                        .from('members')
                        .insert([{ name, cpf }])
                        .select()
                        .maybeSingle();

                    if (insertError) {
                        console.error('Erro ao inserir sócio:', insertError);
                        alert('Erro ao cadastrar sócio: ' + insertError.message);
                        return;
                    }
                    member = inserted;
                }

                currentUser = member;
                isAdmin = false;
                // Members always see the active week
                currentWeekStart = new Date(activeWeekStart);
                document.getElementById('currentMemberName').textContent = name;
                document.getElementById('memberLogin').classList.add('hidden');
                document.getElementById('memberDashboard').classList.remove('hidden');
                await loadBookings();
                updateScheduleDisplay();
            }
        }

        function adminLogin(event) {
            event.preventDefault();
            const user = document.getElementById('adminUser').value;
            const pass = document.getElementById('adminPass').value;

            if (user === 'Admin' && pass === 'Admin') {
                currentUser = { name: 'Administrador' };
                isAdmin = true;
                document.getElementById('adminLogin').classList.add('hidden');
                document.getElementById('adminDashboard').classList.remove('hidden');
                updateAdminScheduleDisplay();
            } else {
                alert('Usuário ou senha incorretos!');
            }
        }

        function logout() {
            currentUser = null;
            isAdmin = false;
            document.getElementById('memberName').value = '';
            document.getElementById('memberCPF').value = '';
            document.getElementById('adminUser').value = '';
            document.getElementById('adminPass').value = '';
            showLoginScreen();
        }

        // Schedule display functions
        function updateScheduleDisplay() {
            const weekDisplay = formatWeekDisplay(currentWeekStart);
            document.getElementById('currentWeekDisplay').textContent = weekDisplay;
            updateDayContent();
        }

        function selectDay(dayIndex) {
            selectedDay = dayIndex;
            
            // Update tab styles
            document.querySelectorAll('.day-tab').forEach((tab, index) => {
                if (index === dayIndex) {
                    tab.className = 'day-tab flex-shrink-0 px-4 py-3 text-sm font-medium rounded-t-lg transition-colors duration-200 bg-green-600 text-white border-b-2 border-green-600 min-w-[80px] touch-manipulation';
                } else {
                    tab.className = 'day-tab flex-shrink-0 px-4 py-3 text-sm font-medium rounded-t-lg transition-colors duration-200 bg-gray-100 text-gray-600 hover:bg-gray-200 active:bg-gray-300 min-w-[80px] touch-manipulation';
                }
            });
            
            updateDayContent();
        }

        function updateDayContent() {
            const timeSlotsContainer = document.getElementById('timeSlots');
            timeSlotsContainer.innerHTML = '';

            const hours = [];
            for (let h = 8; h <= 21; h++) {
                hours.push(`${h.toString().padStart(2, '0')}:00`);
            }

            hours.forEach(hour => {
                const slotKey = `${getWeekKey()}-${selectedDay}-${hour}`;
                const booking = bookings[slotKey];
                const blockKey = `${selectedDay}-${hour}`;
                const isBlocked = blockedSlots[blockKey];
                
                const slotDiv = document.createElement('div');
                slotDiv.className = 'p-3 sm:p-4 rounded-lg border-2 text-center transition-all duration-200 cursor-pointer touch-manipulation min-h-[80px] flex flex-col justify-center';
                
                if (isBlocked) {
                    slotDiv.className += ' bg-gray-800 text-white border-gray-900 cursor-not-allowed';
                    slotDiv.innerHTML = `
                        <div class="font-bold text-lg">${hour}</div>
                        <div class="text-sm mt-1">🚫 Bloqueado</div>
                        <div class="text-xs mt-1 opacity-90">Horário fixo bloqueado</div>
                    `;
                } else if (booking) {
                    if (currentUser && booking.userCPF === currentUser.cpf) {
                        slotDiv.className += ' bg-blue-500 text-white border-blue-600 hover:bg-blue-600';
                        slotDiv.innerHTML = `
                            <div class="font-bold text-lg">${hour}</div>
                            <div class="text-sm mt-1">Meu agendamento</div>
                            <div class="text-xs mt-1 opacity-90">${booking.userName}</div>
                        `;
                        slotDiv.onclick = () => openCancelModal(selectedDay, hour);
                    } else {
                        slotDiv.className += ' bg-red-500 text-white border-red-600';
                        slotDiv.innerHTML = `
                            <div class="font-bold text-lg">${hour}</div>
                            <div class="text-sm mt-1">Ocupado</div>
                            <div class="text-xs mt-1 opacity-90">${booking.userName}</div>
                        `;
                    }
                } else {
                    if (currentUser && canBookSlot(selectedDay, hour)) {
                        slotDiv.className += ' bg-green-500 text-white border-green-600 hover:bg-green-600 hover:scale-105';
                        slotDiv.innerHTML = `
                            <div class="font-bold text-lg">${hour}</div>
                            <div class="text-sm mt-1">Disponível</div>
                            <div class="text-xs mt-1 opacity-90">Clique para agendar</div>
                        `;
                        slotDiv.onclick = () => openBookingModal(selectedDay, hour);
                    } else {
                        slotDiv.className += ' bg-gray-300 text-gray-600 border-gray-400 cursor-not-allowed';
                        slotDiv.innerHTML = `
                            <div class="font-bold text-lg">${hour}</div>
                            <div class="text-sm mt-1">Indisponível</div>
                            <div class="text-xs mt-1 opacity-70">Horário consecutivo</div>
                        `;
                    }
                }
                
                timeSlotsContainer.appendChild(slotDiv);
            });
        }

        function updateAdminScheduleDisplay() {
            const weekDisplay = formatWeekDisplay(currentWeekStart);
            document.getElementById('adminCurrentWeekDisplay').textContent = weekDisplay;
            
            // Show/hide active week indicator
            const activeWeekIndicator = document.getElementById('activeWeekIndicator');
            const isActiveWeek = currentWeekStart && activeWeekStart && (currentWeekStart.toISOString().split('T')[0] === activeWeekStart.toISOString().split('T')[0]);
            if (isActiveWeek) {
                activeWeekIndicator.classList.remove('hidden');
            } else {
                activeWeekIndicator.classList.add('hidden');
            }
            
            updateAdminDayContent();
        }

        function selectAdminDay(dayIndex) {
            selectedAdminDay = dayIndex;
            
            // Update tab styles
            document.querySelectorAll('.admin-day-tab').forEach((tab, index) => {
                if (index === dayIndex) {
                    tab.className = 'admin-day-tab flex-shrink-0 px-4 py-3 text-sm font-medium rounded-t-lg transition-colors duration-200 bg-blue-600 text-white border-b-2 border-blue-600 min-w-[80px] touch-manipulation';
                } else {
                    tab.className = 'admin-day-tab flex-shrink-0 px-4 py-3 text-sm font-medium rounded-t-lg transition-colors duration-200 bg-gray-100 text-gray-600 hover:bg-gray-200 active:bg-gray-300 min-w-[80px] touch-manipulation';
                }
            });
            
            updateAdminDayContent();
        }

        function updateAdminDayContent() {
            const timeSlotsContainer = document.getElementById('adminTimeSlots');
            timeSlotsContainer.innerHTML = '';

            const hours = [];
            for (let h = 8; h <= 21; h++) {
                hours.push(`${h.toString().padStart(2, '0')}:00`);
            }

            hours.forEach(hour => {
                const slotKey = `${getWeekKey()}-${selectedAdminDay}-${hour}`;
                const booking = bookings[slotKey];
                const blockKey = `${selectedAdminDay}-${hour}`;
                const isBlocked = blockedSlots[blockKey];
                
                const slotDiv = document.createElement('div');
                slotDiv.className = 'p-3 sm:p-4 rounded-lg border-2 text-center transition-all duration-200 min-h-[80px] flex flex-col justify-center cursor-pointer touch-manipulation';
                
                if (isBlocked) {
                    slotDiv.className += ' bg-gray-800 text-white border-gray-900';
                    slotDiv.innerHTML = `
                        <div class="font-bold text-lg">${hour}</div>
                        <div class="text-sm mt-1">🚫 Bloqueado Fixo</div>
                        <div class="text-xs mt-1 opacity-90">Clique para desbloquear</div>
                    `;
                    slotDiv.onclick = () => toggleBlockSlot(selectedAdminDay, hour);
                } else if (booking) {
                    slotDiv.className += ' bg-red-500 text-white border-red-600';
                    slotDiv.innerHTML = `
                        <div class="font-bold text-lg">${hour}</div>
                        <div class="text-sm mt-1 font-semibold">${booking.userName}</div>
                        <div class="text-xs mt-1 opacity-90">CPF: ${booking.userCPF}</div>
                    `;
                    if (isBlockMode) {
                        slotDiv.innerHTML += `<div class="text-xs mt-1 opacity-70">Modo bloqueio ativo</div>`;
                    }
                } else {
                    if (isBlockMode) {
                        slotDiv.className += ' bg-orange-500 text-white border-orange-600 hover:bg-orange-600';
                        slotDiv.innerHTML = `
                            <div class="font-bold text-lg">${hour}</div>
                            <div class="text-sm mt-1">Clique para Bloquear</div>
                            <div class="text-xs mt-1 opacity-90">Bloqueio fixo</div>
                        `;
                        slotDiv.onclick = () => toggleBlockSlot(selectedAdminDay, hour);
                    } else {
                        slotDiv.className += ' bg-green-500 text-white border-green-600';
                        slotDiv.innerHTML = `
                            <div class="font-bold text-lg">${hour}</div>
                            <div class="text-sm mt-1">Disponível</div>
                            <div class="text-xs mt-1 opacity-90">Sem agendamento</div>
                        `;
                    }
                }
                
                timeSlotsContainer.appendChild(slotDiv);
            });
        }

        // Booking logic
        function canBookSlot(dayIndex, hour) {
            // Check if slot is blocked
            const blockKey = `${dayIndex}-${hour}`;
            if (blockedSlots[blockKey]) {
                return false;
            }

            if (!currentUser) return false;

            const weekKey = getWeekKey();
            // Check for consecutive bookings by this user in the same day/week
            const currentHour = parseInt(hour.split(':')[0]);
            const prevHour = `${(currentHour - 1).toString().padStart(2, '0')}:00`;
            const nextHour = `${(currentHour + 1).toString().padStart(2, '0')}:00`;
            
            const prevSlotKey = `${weekKey}-${dayIndex}-${prevHour}`;
            const nextSlotKey = `${weekKey}-${dayIndex}-${nextHour}`;
            
            if ((bookings[prevSlotKey]?.userCPF === currentUser.cpf) || 
                (bookings[nextSlotKey]?.userCPF === currentUser.cpf)) {
                return false;
            }

            // Also ensure the slot isn't already booked
            const thisSlotKey = `${weekKey}-${dayIndex}-${hour}`;
            if (bookings[thisSlotKey]) return false;

            return true;
        }

        function openBookingModal(dayIndex, hour) {
            if (!canBookSlot(dayIndex, hour)) {
                alert('Você não pode agendar horários consecutivos ou horário bloqueado!');
                return;
            }

            selectedSlot = { dayIndex, hour };
            const days = ['Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado', 'Domingo'];
            document.getElementById('bookingTime').textContent = hour;
            document.getElementById('bookingDay').textContent = days[dayIndex];
            document.getElementById('bookingModal').classList.remove('hidden');
        }

        function closeBookingModal() {
            document.getElementById('bookingModal').classList.add('hidden');
            selectedSlot = null;
        }

        async function confirmBooking() {
            if (selectedSlot) {
                const weekKey = getWeekKey();

                // Double-check slot availability on server
                const { data: existing, error: selectError } = await supabase
                    .from('bookings')
                    .select('*')
                    .eq('week_start', weekKey)
                    .eq('day_index', selectedSlot.dayIndex)
                    .eq('hour', selectedSlot.hour)
                    .limit(1);

                if (selectError) {
                    alert('Erro ao verificar horário: ' + selectError.message);
                    return;
                }

                if (existing && existing.length > 0) {
                    alert('Este horário já foi reservado por outra pessoa.');
                    await loadBookings();
                    updateScheduleDisplay();
                    closeBookingModal();
                    return;
                }

                // Insert booking
                const { error } = await supabase.from('bookings').insert([{
                    member_id: currentUser.id,
                    week_start: weekKey,
                    day_index: selectedSlot.dayIndex,
                    hour: selectedSlot.hour
                }]);

                if (error) {
                    alert('Erro ao agendar: ' + error.message);
                    return;
                }

                await loadBookings();
                updateScheduleDisplay();
                closeBookingModal();
                alert('Agendamento realizado com sucesso!');
            }
        }

        function openCancelModal(dayIndex, hour) {
            selectedSlot = { dayIndex, hour };
            const days = ['Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado', 'Domingo'];
            document.getElementById('cancelTime').textContent = hour;
            document.getElementById('cancelDay').textContent = days[dayIndex];
            document.getElementById('cancelModal').classList.remove('hidden');
        }

        function closeCancelModal() {
            document.getElementById('cancelModal').classList.add('hidden');
            selectedSlot = null;
        }

        async function confirmCancel() {
            if (selectedSlot) {
                const weekKey = getWeekKey();
                // Delete only if owner (member) or if admin allow deleting any
                let query = supabase
                    .from('bookings')
                    .delete()
                    .eq('week_start', weekKey)
                    .eq('day_index', selectedSlot.dayIndex)
                    .eq('hour', selectedSlot.hour);

                if (!isAdmin && currentUser) {
                    query = query.eq('member_id', currentUser.id);
                }

                const { error } = await query;

                if (error) {
                    alert('Erro ao cancelar: ' + error.message);
                    return;
                }

                await loadBookings();
                updateScheduleDisplay();
                closeCancelModal();
                alert('Agendamento cancelado com sucesso!');
            }
        }

        // Admin functions
        async function previousWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            saveWeekState();
            await loadBookings();
            updateAdminScheduleDisplay();
        }

        async function nextWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            saveWeekState();
            await loadBookings();
            updateAdminScheduleDisplay();
        }

        function setActiveWeek() {
            const weekDisplay = formatWeekDisplay(currentWeekStart);
            if (confirm(`Deseja definir a semana de ${weekDisplay} como a semana vigente para agendamentos dos sócios?`)) {
                activeWeekStart = new Date(currentWeekStart);
                saveWeekState();
                alert('Semana vigente definida com sucesso! Os sócios agora podem agendar nesta semana.');
            }
        }

        // Block management functions
        function toggleBlockMode() {
            isBlockMode = !isBlockMode;
            const btn = document.getElementById('blockModeBtn');
            if (isBlockMode) {
                btn.textContent = 'Modo Bloqueio: ON';
                btn.className = 'bg-orange-700 hover:bg-orange-800 active:bg-orange-900 text-white px-4 py-3 rounded-lg transition duration-200 text-sm font-medium touch-manipulation';
            } else {
                btn.textContent = 'Modo Bloqueio: OFF';
                btn.className = 'bg-orange-600 hover:bg-orange-700 active:bg-orange-800 text-white px-4 py-3 rounded-lg transition duration-200 text-sm font-medium touch-manipulation';
            }
            updateAdminScheduleDisplay();
        }

        async function toggleBlockSlot(dayIndex, hour) {
            const blockKey = `${dayIndex}-${hour}`;
            const days = ['Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado', 'Domingo'];
            
            if (blockedSlots[blockKey]) {
                // Unblock
                if (confirm(`Deseja desbloquear o horário ${hour} nas ${days[dayIndex]}s de todas as semanas futuras?`)) {
                    await supabase.from('blocked_slots').delete().eq('id', blockedSlots[blockKey].id);
                }
            } else {
                // Block
                if (confirm(`Deseja bloquear o horário ${hour} nas ${days[dayIndex]}s de todas as semanas futuras?\n\nEste bloqueio será aplicado automaticamente a todas as próximas semanas até ser cancelado.`)) {
                    await supabase.from('blocked_slots').insert([{ day_index: dayIndex, hour }]);
                }
            }

            await loadBlocks();
            updateAdminScheduleDisplay();
            updateBlocksList();
            alert('Operação de bloqueio concluída.');
        }

        function openBlockModal() {
            updateBlocksList();
            document.getElementById('blockModal').classList.remove('hidden');
        }

        function closeBlockModal() {
            document.getElementById('blockModal').classList.add('hidden');
        }

        async function updateBlocksList() {
            const blocksList = document.getElementById('activeBlocksList');
            blocksList.innerHTML = '';

            const blocks = Object.keys(blockedSlots);
            if (blocks.length === 0) {
                blocksList.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum bloqueio ativo</p>';
                return;
            }

            blocks.forEach(blockKey => {
                const block = blockedSlots[blockKey];
                const blockDiv = document.createElement('div');
                blockDiv.className = 'flex justify-between items-center p-3 bg-gray-100 rounded-lg';
                blockDiv.innerHTML = `
                    <div>
                        <div class="font-semibold">${block.day_index === 0 ? 'Segunda' : block.day_index === 1 ? 'Terça' : block.day_index === 2 ? 'Quarta' : block.day_index === 3 ? 'Quinta' : block.day_index === 4 ? 'Sexta' : block.day_index === 5 ? 'Sábado' : 'Domingo'} - ${block.hour}</div>
                        <div class="text-sm text-gray-600">Criado em: ${new Date(block.created_at).toLocaleDateString('pt-BR')}</div>
                    </div>
                    <button onclick="removeBlock('${blockKey}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                        Remover
                    </button>
                `;
                blocksList.appendChild(blockDiv);
            });
        }

        async function removeBlock(blockKey) {
            const block = blockedSlots[blockKey];
            if (confirm(`Deseja remover o bloqueio de ${block.day_index === 0 ? 'Segunda' : block.day_index === 1 ? 'Terça' : block.day_index === 2 ? 'Quarta' : block.day_index === 3 ? 'Quinta' : block.day_index === 4 ? 'Sexta' : block.day_index === 5 ? 'Sábado' : 'Domingo'} às ${block.hour}?`)) {
                await supabase.from('blocked_slots').delete().eq('id', block.id);
                await loadBlocks();
                updateBlocksList();
                updateAdminScheduleDisplay();
                alert('Bloqueio removido com sucesso!');
            }
        }

        // -------------------------
        // Data loading (from Supabase)
        // -------------------------
        async function loadBookings() {
            // load bookings for currentWeekStart
            if (!currentWeekStart) return;
            const weekKey = getWeekKey();

            const { data, error } = await supabase
                .from('bookings')
                .select('id, member_id, week_start, day_index, hour, created_at, members(name, cpf)')
                .eq('week_start', weekKey);

            bookings = {};
            if (error) {
                console.error('Erro ao carregar agendamentos:', error);
                return;
            }
            if (data) {
                data.forEach(b => {
                    const slotKey = `${b.week_start}-${b.day_index}-${b.hour}`;
                    bookings[slotKey] = {
                        id: b.id,
                        member_id: b.member_id,
                        userName: b.members ? b.members.name : '',
                        userCPF: b.members ? b.members.cpf : ''
                    };
                });
            }
        }

        async function loadBlocks() {
            const { data, error } = await supabase
                .from('blocked_slots')
                .select('*');

            blockedSlots = {};
            if (error) {
                console.error('Erro ao carregar bloqueios:', error);
                return;
            }
            if (data) {
                data.forEach(b => {
                    blockedSlots[`${b.day_index}-${b.hour}`] = b;
                });
            }
        }

        // Utility functions
        function getWeekKey() {
            // returns YYYY-MM-DD of currentWeekStart
            return currentWeekStart.toISOString().split('T')[0];
        }

        function formatWeekDisplay(weekStart) {
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            
            const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
            return `${weekStart.toLocaleDateString('pt-BR', options)} a ${weekEnd.toLocaleDateString('pt-BR', options)}`;
        }

        // Initialize system on load
        initSystem();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9801d84d77b0c134',t:'MTc1ODA0MTIzOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agendamento Clube de T√™nis</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
</head>
<body class="bg-gray-100">

  <!-- Header -->
  <header class="bg-white shadow p-4 flex justify-between items-center">
    <div class="flex items-center gap-3">
      <img src="https://i.postimg.cc/9FG4YkXP/logo.jpg" alt="Logo do Clube" class="h-12">
      <h1 class="text-lg font-bold">Clube de T√™nis</h1>
    </div>
    <div id="userInfo" class="hidden flex items-center gap-4">
      <div>
        <div id="userName" class="font-semibold"></div>
        <div id="userCpf" class="text-sm text-gray-500"></div>
      </div>
      <button onclick="logout()" class="bg-red-500 text-white px-3 py-1 rounded">Sair</button>
    </div>
  </header>

  <!-- Login/Cadastro -->
  <div id="authContainer" class="max-w-md mx-auto mt-8 bg-white shadow rounded p-6">
    <div class="flex mb-4">
      <button id="loginTab" onclick="showLogin()" class="flex-1 py-2 bg-green-500 text-white rounded-l">Login</button>
      <button id="registerTab" onclick="showRegister()" class="flex-1 py-2 bg-gray-200 text-gray-700 rounded-r">Cadastro</button>
    </div>

    <form id="loginForm" onsubmit="login(event)">
      <input type="text" id="loginCpf" placeholder="CPF" class="w-full mb-3 p-2 border rounded">
      <button type="submit" class="w-full bg-green-500 text-white py-2 rounded">Entrar</button>
    </form>

    <form id="registerForm" class="hidden" onsubmit="register(event)">
      <input type="text" id="registerName" placeholder="Nome Completo" class="w-full mb-3 p-2 border rounded">
      <input type="text" id="registerCpf" placeholder="CPF" class="w-full mb-3 p-2 border rounded">
      <button type="submit" class="w-full bg-green-500 text-white py-2 rounded">Cadastrar</button>
    </form>
  </div>

  <!-- App -->
  <main id="mainApp" class="hidden max-w-4xl mx-auto mt-8 bg-white shadow rounded p-6">
    <h2 class="text-xl font-bold mb-4">Agenda</h2>
    <div id="scheduleGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2"></div>

    <h2 class="text-xl font-bold mt-8 mb-4">Meus Agendamentos</h2>
    <div id="myBookings" class="space-y-2"></div>
  </main>

<script>
  // ‚öôÔ∏è Configura√ß√£o Supabase
  const supabase = supabase.createClient(
    "https://SEU-PROJETO.supabase.co", // üî¥ Troque aqui
    "SEU-ANON-KEY" // üî¥ Troque aqui
  );

  let currentUser = null;

  // ----------------- UI -----------------
  function showLogin() {
    document.getElementById("loginForm").classList.remove("hidden");
    document.getElementById("registerForm").classList.add("hidden");
  }
  function showRegister() {
    document.getElementById("loginForm").classList.add("hidden");
    document.getElementById("registerForm").classList.remove("hidden");
  }
  function logout() {
    currentUser = null;
    localStorage.removeItem("currentTennisUser");
    document.getElementById("authContainer").classList.remove("hidden");
    document.getElementById("userInfo").classList.add("hidden");
    document.getElementById("mainApp").classList.add("hidden");
  }

  // ----------------- Cadastro -----------------
  async function register(event) {
    event.preventDefault();
    const name = document.getElementById("registerName").value.trim();
    const cpf = document.getElementById("registerCpf").value.replace(/\D/g, "");

    const { error } = await supabase.from("users").insert([{ name, cpf }]);
    if (error) { alert("Erro ao cadastrar!"); return; }

    alert("Cadastro realizado!");
    showLogin();
  }

  // ----------------- Login -----------------
  async function login(event) {
    event.preventDefault();
    const cpf = document.getElementById("loginCpf").value.replace(/\D/g, "");

    const { data: user, error } = await supabase
      .from("users")
      .select("*")
      .eq("cpf", cpf)
      .single();

    if (error || !user) { alert("CPF n√£o encontrado!"); return; }

    currentUser = user;
    localStorage.setItem("currentTennisUser", JSON.stringify(user));
    document.getElementById("userName").textContent = user.name;
    document.getElementById("userCpf").textContent = `CPF: ${user.cpf}`;
    document.getElementById("authContainer").classList.add("hidden");
    document.getElementById("userInfo").classList.remove("hidden");
    document.getElementById("mainApp").classList.remove("hidden");

    updateScheduleGrid();
    updateMyBookings();
  }

  // ----------------- Agenda -----------------
  async function updateScheduleGrid() {
    const container = document.getElementById("scheduleGrid");
    container.innerHTML = "";

    const today = new Date().toISOString().split("T")[0];
    const { data: bookings, error } = await supabase
      .from("bookings")
      .select("*")
      .eq("date", today);

    if (error) { console.error(error); return; }

    for (let hour = 8; hour < 22; hour++) {
      const timeStr = `${hour.toString().padStart(2, "0")}:00`;
      const booking = bookings?.find(b => b.time === timeStr);
      const isMyBooking = booking && booking.user_id === currentUser.id;

      const slot = document.createElement("div");
      slot.className = "p-3 rounded text-center cursor-pointer text-white";

      if (isMyBooking) {
        slot.classList.add("bg-yellow-500");
        slot.textContent = `${timeStr} (Meu)`;
        slot.onclick = () => cancelBooking(booking.id);
      } else if (booking) {
        slot.classList.add("bg-red-500");
        slot.textContent = `${timeStr} (Ocupado)`;
      } else {
        slot.classList.add("bg-green-500");
        slot.textContent = `${timeStr}`;
        slot.onclick = () => bookSlot(today, timeStr);
      }

      container.appendChild(slot);
    }
  }

  async function bookSlot(date, time) {
    const { error } = await supabase.from("bookings").insert([{
      user_id: currentUser.id,
      date, time
    }]);
    if (error) { alert("Erro ao agendar!"); return; }
    updateScheduleGrid();
    updateMyBookings();
  }

  async function cancelBooking(id) {
    const { error } = await supabase.from("bookings").delete().eq("id", id);
    if (error) { alert("Erro ao cancelar!"); return; }
    updateScheduleGrid();
    updateMyBookings();
  }

  // ----------------- Meus agendamentos -----------------
  async function updateMyBookings() {
    const container = document.getElementById("myBookings");
    const { data: bookings, error } = await supabase
      .from("bookings")
      .select("*")
      .eq("user_id", currentUser.id)
      .order("date")
      .order("time");

    if (error) { console.error(error); return; }

    if (!bookings || bookings.length === 0) {
      container.innerHTML = "<p class='text-gray-500'>Nenhum agendamento</p>";
      return;
    }

    container.innerHTML = bookings.map(b => `
      <div class="flex justify-between bg-gray-100 p-2 rounded">
        <span>${b.date} ${b.time}</span>
        <button onclick="cancelBooking('${b.id}')" class="bg-red-500 text-white px-2 rounded">Cancelar</button>
      </div>
    `).join("");
  }

  // Garantir fun√ß√µes globais
  window.register = register;
  window.login = login;
  window.logout = logout;
  window.updateScheduleGrid = updateScheduleGrid;
  window.bookSlot = bookSlot;
  window.cancelBooking = cancelBooking;
  window.updateMyBookings = updateMyBookings;
</script>
</body>
</html>
